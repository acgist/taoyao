/**
 * ä¿¡ä»¤
 *
 * çº¿ç¨‹æ¨¡å‹è®¾è®¡çœŸçš„æ˜¯ä¸ªå°ä¸‘ğŸ¤¡ğŸ¤¡ğŸ¤¡ğŸ¤¡
 *
 * @author acgist
 */

import hilog from "@ohos.hilog";
import List from '@ohos.util.List';
import { BusinessError } from '@ohos.base';
import webSocket from "@ohos.net.webSocket";

import { setting } from "./Setting";

import taoyaoModule from "libtaoyao.so";

class TaoyaoSignal {

  // WebSocketä¿¡ä»¤è¿æ¥
  socket   : webSocket.WebSocket | null = null;
  // æ˜¯å¦å…³é—­
  closed   : boolean = false;
  // æ˜¯å¦è¿æ¥æˆåŠŸ
  connected: boolean = false;
  // å¿ƒè·³å®šæ—¶
  heartbeatTimer: number = 0;
  // æœ¬åœ°å›è°ƒ
  nativeCallback  = new List<number>();
  // åŒæ­¥è¯·æ±‚
  callbackMapping = new Map<number, Function>();
  // å½“å‰æ¶ˆæ¯ç´¢å¼•ï¼š0-666
  index   : number = 0;
  // æœ€å°æ¶ˆæ¯ç´¢å¼•
  minIndex: number = 0;
  // æœ€å¤§æ¶ˆæ¯ç´¢å¼•
  maxIndex: number = 666;

  /**
   * åŠ è½½ç³»ç»Ÿ
   * å»ºè®®æ³¨å†ŒæˆåŠŸä»¥ååŠ è½½
   */
  init() {
    hilog.info(0x0000, "TaoyaoSignal", "åŠ è½½ç³»ç»Ÿ");
    taoyaoModule.init(JSON.stringify(setting.config), this.nativePush, this.nativeRequest);
  }

  /**
   * å¸è½½ç³»ç»Ÿ
   */
  shutdown() {
    hilog.info(0x0000, "TaoyaoSignal", "å¸è½½ç³»ç»Ÿ");
    taoyaoModule.shutdown(JSON.stringify(setting.config));
  }

  /**
   * è¿æ¥ä¿¡ä»¤
   */
  connect() {
    if(this.connected) {
      return;
    }
    if(this.socket) {
      hilog.info(0x0000, "TaoyaoSignal", "ä¿¡ä»¤å·²ç»è¿æ¥å…³é—­æ—§çš„è¿æ¥ï¼š%{public}s", setting.signalAddress);
      this.socket.close();
      this.socket = null;
    }
    this.connected = false;
    this.socket = webSocket.createWebSocket();
    this.socket.on("open", (err: BusinessError, value: Object) => {
      hilog.info(0x0000, "TaoyaoSignal", "æ‰“å¼€ä¿¡ä»¤ï¼š%{public}s %{public}s %{public}s", setting.signalAddress, JSON.stringify(value), JSON.stringify(err));
      this.register();
      this.connected = true;
    });
    this.socket.on("message", (err: BusinessError, value: string | ArrayBuffer) => {
      const message = value?.toString();
      hilog.debug(0x0000, "TaoyaoSignal", "ä¿¡ä»¤æ¶ˆæ¯ï¼š%{public}s %{public}s", message, JSON.stringify(err));
      try {
        this.onMessage(message);
      } catch (error) {
        hilog.error(0x0000, "TaoyaoSignal", "å¤„ç†ä¿¡ä»¤æ¶ˆæ¯å¼‚å¸¸ï¼š%{public}s %{public}s", message, JSON.stringify(error));
      }
    });
    this.socket.on("close", (err: BusinessError, value: Object) => {
      hilog.error(0x0000, "TaoyaoSignal", "å…³é—­ä¿¡ä»¤ï¼š%{public}s %{public}s %{public}s", setting.signalAddress, JSON.stringify(value), JSON.stringify(err));
      this.connected = false;
      this.reconnect();
    });
    this.socket.on("error", (err: BusinessError) => {
      hilog.error(0x0000, "TaoyaoSignal", "ä¿¡ä»¤å¼‚å¸¸ï¼š%{public}s %{public}s", setting.signalAddress, JSON.stringify(err));
      this.connected = false;
      this.reconnect();
    });
    // é…ç½®CAè¯ä¹¦
    const caPath = getContext(this).cacheDir + setting.caPath;
    hilog.info(0x0000, "TaoyaoSignal", "é…ç½®è¯ä¹¦ï¼š%{public}s", caPath);
    const options: webSocket.WebSocketRequestOptions = {
      caPath: caPath
    };
    hilog.info(0x0000, "TaoyaoSignal", "è¿æ¥ä¿¡ä»¤ï¼š%{public}s", setting.signalAddress);
    this.socket.connect(setting.signalAddress, options, (err: BusinessError, value: boolean) => {
      hilog.info(0x0000, "TaoyaoSignal", "ä¿¡ä»¤è¿æ¥ï¼š%{public}s %{public}s %{public}s", setting.signalAddress, JSON.stringify(value), JSON.stringify(err));
    });
  };

  /**
   * é‡è¿ä¿¡ä»¤
   */
  reconnect() {
    if(this.closed) {
      // å·²ç»å…³é—­å¿½ç•¥é‡è¿
    } else {
      hilog.info(0x0000, "TaoyaoSignal", "é‡è¿ä¿¡ä»¤è¿æ¥ï¼š%{public}s", setting.signalAddress);
      setTimeout((): void => this.connect(), 5000);
    }
  }

  /**
   * å…³é—­ä¿¡ä»¤
   */
  close() {
    hilog.info(0x0000, "TaoyaoSignal", "å…³é—­ä¿¡ä»¤ï¼š%{public}s", setting.signalAddress);
    this.closed    = true;
    this.connected = false;
    if(this.socket) {
      this.socket.close();
      this.socket = null;
    }
    if(this.heartbeatTimer) {
      clearInterval(this.heartbeatTimer);
      this.heartbeatTimer = 0;
    }
  }

  /**
   * æ³¨å†Œä¿¡ä»¤
   */
  async register() {
    const response: Record<string, Object> = await this.request("client::register", {
      "name"      : setting.config.name,
      "clientId"  : setting.config.clientId,
      "clientType": setting.config.clientType,
      "username"  : setting.config.username,
      "password"  : setting.config.password,
      "battery"   : 100,
      "charging"  : true
    });
    const body  = response.body as Record<string, Object>;
    const index = body.index    as number;
    setting.config.clientIndex = index;
    hilog.info(0x0000, "TaoyaoSignal", "ä¿¡ä»¤æ³¨å†ŒæˆåŠŸï¼š%{public}d", index);
    this.heartbeat();
    if(setting.initOnLoad) {
      taoyaoSignal.init();
    }
  }

  /**
   * å¿ƒè·³ä¿¡ä»¤
   */
  heartbeat() {
    if(this.heartbeatTimer) {
      clearInterval(this.heartbeatTimer);
    }
    this.heartbeatTimer = setInterval(() => {
      this.push("client::heartbeat", {
        "battery" : 100,
        "charging": true,
      });
    }, 30 * 1000);
  };

  /**
   * @returns ID
   */
  buildId(): number {
    if (++this.index > this.maxIndex) {
      this.index = this.minIndex;
    }
    const date = new Date();
    return (
      100000000000000 * date.getDate()             +
      1000000000000   * date.getHours()            +
      10000000000     * date.getMinutes()          +
      100000000       * date.getSeconds()          +
      1000            * setting.config.clientIndex +
      this.index
    );
  }

  /**
   * å‘é€æ¶ˆæ¯
   *
   * @param signal ä¿¡ä»¤
   * @param body   ä¸»ä½“
   * @param oldId  æ—§çš„ID
   */
  push(signal: string, body: Record<string, Object>, oldId: number = 0) {
    const id = oldId || this.buildId();
    const header: Record<string, Object> = {
      "v"     : setting.version,
      "id"    : id,
      "signal": signal
    };
    const message: Record<string, Object> = {
      "header": header,
      "body"  : body
    };
    const json = JSON.stringify(message);
    try {
      hilog.debug(0x0000, "TaoyaoSignal", "å‘é€æ¶ˆæ¯ï¼š%{public}s", json);
      this.socket?.send(json);
    } catch (error) {
      hilog.error(0x0000, "TaoyaoSignal", "å‘é€æ¶ˆæ¯å¼‚å¸¸ï¼š%{public}s %{public}s", json, JSON.stringify(error));
    }
  }

  /**
   * è¯·æ±‚æ¶ˆæ¯
   *
   * @param signal ä¿¡ä»¤
   * @param body   ä¸»ä½“
   * @param oldId  æ—§çš„ID
   *
   * @returns å“åº”
   */
  async request(signal: string, body: Record<string, Object>, oldId: number = 0): Promise<Record<string, Object>> {
    return new Promise<Record<string, Object>>((resolve, reject) => {
      const id = oldId || this.buildId();
      const header: Record<string, Object> = {
        "v"     : setting.version,
        "id"    : id,
        "signal": signal
      };
      const message: Record<string, Object> = {
        "header": header,
        "body"  : body
      };
      // è®¾ç½®è¶…æ—¶
      const rejectTimeout = setTimeout(() => {
        this.callbackMapping.delete(id);
        reject("è¯·æ±‚è¶…æ—¶");
      }, 5000);
      // è¯·æ±‚å›è°ƒ
      this.callbackMapping.set(id, (response: Record<string, Object>) => {
        resolve(response);
        clearTimeout(rejectTimeout);
        // é»˜è®¤ä¸ç”¨ç»§ç»­å¤„ç†
        return true;
      });
      // å‘é€æ¶ˆæ¯
      const json = JSON.stringify(message);
      try {
        hilog.debug(0x0000, "TaoyaoSignal", "å‘é€è¯·æ±‚ï¼š%{public}s", json);
        this.socket?.send(json);
      } catch (error) {
        hilog.error(0x0000, "TaoyaoSignal", "å‘é€æ¶ˆæ¯å¼‚å¸¸ï¼š%{public}s %{public}s", json, JSON.stringify(error));
        reject(error);
      }
    });
  }

  /**
   * å¤„ç†æ¶ˆæ¯
   *
   * @param message æ¶ˆæ¯
   */
  onMessage(message: string) {
    const json  : Record<string, Object> = JSON.parse(message);
    const header: Record<string, Object> = json.header as Record<string, Object>;
    const id    : number = header.id     as number;
    const signal: string = header.signal as string;
    if(this.nativeCallback.has(id)) {
      hilog.debug(0x0000, "TaoyaoSignal", "å¤„ç†åŒæ­¥æ¶ˆæ¯(NAPI)ï¼š%{public}s", message);
      try {
        taoyaoModule.callback(message);
      } finally {
        this.nativeCallback.remove(id);
      }
      return;
    }
    if (this.callbackMapping.has(id)) {
      hilog.debug(0x0000, "TaoyaoSignal", "å¤„ç†åŒæ­¥æ¶ˆæ¯(ETS)ï¼š%{public}s", message);
      try {
        const callback = this.callbackMapping.get(id) as Function;
        if(callback(json)) {
          return;
        }
      } finally {
        this.callbackMapping.delete(id);
      }
    }
    let ret: number = 0;
    switch (signal) {
      case "room::close":
        // ret = taoyaoModule.roomClose(message);
        break;
      case "room::enter":
        // ret = taoyaoModule.roomEnter(message);
        break;
      case "room::expel":
        // ret = taoyaoModule.roomExpel(message);
        break;
      case "room::invite":
        ret = taoyaoModule.roomInvite(message);
        break;
      case "room::leave":
        // ret = taoyaoModule.roomLeave(message);
        break;
      case "room::client::list":
        // ret = taoyaoModule.roomClientList(message);
        break;
      case "media::consume":
        // ret = taoyaoModule.mediaConsume(message);
        break;
      case "media::consumer::close":
        // ret = taoyaoModule.mediaConsumerClose(message);
        break;
      case "media::consumer::pause":
        // ret = taoyaoModule.mediaConsumerPause(message);
        break;
      case "media::consumer::resume":
        // ret = taoyaoModule.mediaConsumerResume(message);
        break;
      case "media::producer::close":
        // ret = taoyaoModule.mediaProducerClose(message);
        break;
      case "media::producer::pause":
        // ret = taoyaoModule.mediaProducerPause(message);
        break;
      case "media::producer::resume":
        // ret = taoyaoModule.mediaProducerResume(message);
        break;
      default:
        ret = -1;
        hilog.warn(0x0000, "TaoyaoSignal", "æ²¡æœ‰é€‚é…ä¿¡ä»¤ï¼š%{public}s", signal);
        break;
    }
    hilog.debug(0x0000, "TaoyaoSignal", "å¤„ç†å¼‚æ­¥æ¶ˆæ¯ï¼š%{public}d %{public}s", ret, message);
  }

  /**
   * æ³¨å†Œå‘é€æ¶ˆæ¯
   *
   * @param signal ä¿¡ä»¤
   * @param body   ä¸»ä½“
   * @param id     ID
   */
  nativePush(signal: string, body: string, id: number = 0) {
    taoyaoSignal.push(signal, JSON.parse(body), id);
  }

  /**
   * æ³¨å†Œè¯·æ±‚æ¶ˆæ¯
   *
   * @param signal ä¿¡ä»¤
   * @param body   ä¸»ä½“
   * @param id     ID
   */
  nativeRequest(signal: string, body: string, id: number = 0) {
    taoyaoSignal.nativeCallback.add(id);
    taoyaoSignal.push(signal, JSON.parse(body), id);
    setTimeout(() => {
      taoyaoSignal.nativeCallback.remove(id);
    }, 5000);
  }

}

const taoyaoSignal = new TaoyaoSignal();

if(setting.initOnLoad) {
  taoyaoSignal.connect();
}

export {
  taoyaoSignal
}
